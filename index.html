<!--
Copyright © 2015-2017 A-Frame authors.
Released under the MIT license
https://opensource.org/licenses/mit-license.php

-->


<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<link rel="stylesheet" href="./style.css" />

<link rel="prefetch" href="./gltf/Pagoda.glb">
<link rel="prefetch" href="./gltf/Avocado.glb">
<title>vr_meiro</title>
<!--script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.12.4/dist/aframe-extras.min.js"></script-->

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-environment-component@2.0.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
<!--physicsは頭で読むとエラーになるが下げると壁突き抜けるのでひとまず-->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>
   
<style>
.fade{
    -webkit-transition: all 1s;
    -moz-transition: all 1s;
    -ms-transition: all 1s;
    -o-transition: all 1s;
    transition: all 1s;
    transition-delay:10s;
    opacity: 0.5;
　　　}

/*消える*/
.fade1{
 opacity:0;
 pointer-events:none
      }

/*出る*/
.fade2{
 opacity:0.5;
 pointer-events:auto;
 transition-delay:0s;
      }

#inputNum{
  z-index:2;
  position:fixed;
  top:92%;
  left:5%;
  width:75px;
  padding:10px;
  border:white;
  border-radius:5px;
}

#video1{
  z-index:1;
}
</style>

<script>

/*
var speed = 0.01;
var isIntersect = false;
//resigterはscene読み込む前じゃないとng
AFRAME.registerComponent('collider-check',
{
    dependencies: ['raycaster'],
    init: function ()
    {
        this.el.addEventListener('raycaster-intersection', function ()
        {
            isIntersect = true;
        });
        this.el.addEventListener('raycaster-intersection-cleared', function ()
        {
            isIntersect = false;
        });
    }
});
*/


AFRAME.registerComponent('abo-listener',
    {
        init: function ()
     {
      this.el.addEventListener('fusing',function(evt)
      {
      document.getElementById("text1").setAttribute('visible','true');
      },false);

      this.el.addEventListener('mouseleave',function(evt)
      {
      document.getElementById("text1").setAttribute('visible','false');
      },false);
    }

    });




/*
var speed = 0.01;
var isIntersect = false;


function movePlayer()
{
    var camera = document.getElementById('camera');

    if (camera && !isIntersect)
    {
        var position = camera.getAttribute('position');
        var rotation = camera.getAttribute('rotation');

        position.x += -Math.cos((rotation.y - 90) * Math.PI / 180) * speed;
        position.z += Math.sin((rotation.y - 90) * Math.PI / 180) * speed;
        camera.setAttribute('position', position);
    }
}


var t = 0;

function render()
{
    t += 0.01;
    requestAnimationFrame(render);
    movePlayer();
}

render();
*/


</script>

</head>

<body class="a-body">

<div id="back" style='position: fixed; top: 85%; width:100%;text-align: center; z-index: 100;'>
    <button style="width:10vw;height:8vh">
        back
    </button>
</div>

<!-- kinematic-body static-body physicallyCorrectLights:true"-->
<a-scene id="myScene" inspector="" renderer="antialias:true;colorManagement:true; class="fullscreen" keyboard-shortcuts="" screenshot="" vr-mode-ui="" physics="debug: false;gravity:0">


<!--a-assets  動くけどエラーでたのでentityから直接読み込み>
  <a-asset-item id="model" crossOrigin="anonymous" src="./gltf/Pagoda.glb"></a-asset-item>
  <a-asset-item id="model2" crossOrigin="anonymous" src="./gltf/Avocado.glb"></a-asset-item>
</a-assets-->

<!--a-entity id="camera" camera look-controls wasd-controls jump-ability raycaster="objects: .collidable; far: 0.5;" collider-check rotation="0 0 0" position="0 0.3 0" kinematic-body></a-entity-->
<!--look-controls wasd-controls universal-controls-->

<!--radius超重要-->
<!--gravity:0にすれば、position.yの位置から落ちない-->
<a-entity id="rig" movement-controls="speed:0.05" kinematic-body="radius: 0.5" position="0 0.8 0" >
  <a-entity camera id="camera" look-controls="pointerLockEnabled: true">

    <a-entity cursor="fuse:true;fuse-timeout:500;" position="0 0 -1"
              geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
              material="color: gray; shader: flat"></a-entity>
  </a-entity>
</a-entity>


<a-entity id="maze" position="-4 1 -10" >
    <!--a-box class="collidable" position="0 0 0" width="1" height="2" depth="1" color="#4CC3D9" static-body></a-box>
    <a-box class="collidable" position="0 0 1" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 3" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 4" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 6" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 7" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="0 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="1 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="1 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="1 0 6" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="1 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="2 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="2 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="2 0 3" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="2 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="3 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="3 0 4" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="3 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="3 0 7" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="3 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="4 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="4 0 1" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="4 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="4 0 4" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="4 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="5 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="5 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="5 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="5 0 7" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="5 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="6 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="6 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="6 0 3" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="6 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="6 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="7 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="7 0 7" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="7 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>

    <a-box class="collidable" position="8 0 0" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 1" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 2" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 3" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 4" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 5" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 6" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 7" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box>
    <a-box class="collidable" position="8 0 8" width="1" height="2" depth="1" color="#4CC3D9"static-body></a-box-->

<a-entity id="cg" class="collidable" gltf-model="url(./gltf/Pagoda.glb)" scale="0.01 0.01 0.01" position="1 -1 3" rotation="0 0 0" animation-mixer 
animation__in="property: scale;
               to: 0.03 0.03 0.03;
               dur: 100;
               startEvents: mouseenter"
animation__out="property: scale;
               to: 0.01 0.01 0.01;
               dur: 100;
               startEvents: mouseleave"
static-body></a-entity>


<a-entity id="cg" class="collidable" gltf-model="url(./gltf/Avocado.glb)" scale="5 5 5" position="2 -1 4" rotation="0 0 0" animation-mixer abo-listener
animation__in="property: scale;
               to: 10 10 10;
               dur: 100;
               startEvents: mouseenter"
animation__out="property: scale;
               to: 5 5 5;
               dur: 100;
               startEvents: mouseleave"
static-body cursor-listener></a-entity>

<a-entity id="text1" text="value: Hello World;align:center" visible="false" scale="3 3 3" position="2 0 4" static-body ></a-entity>
<!--text="value: Hello World;align:center"-->


</a-entity>



<a-plane id="myStage" static-body material="color: grey" width="100" height="100" rotation="-90 0 0" position="0 0 0"></a-plane>


    <!--script src="https://rawgit.com/rdub80/aframe-gui/master/dist/aframe-gui.min.js"></script--> <!--GUI Library-->
    <!--script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script-->



<script>



var inputData=[
               [1,1,1,1,1,1,1,1,1],[0,0,1,0,0,1,1,0,1],[1,0,1,1,0,0,0,0,1],[1,0,0,0,1,1,0,1,1],
               [1,1,1,0,1,1,0,0,0],[1,0,1,0,0,1,0,1,1],[1,0,1,1,0,1,0,0,1],[1,0,0,0,0,0,0,1,1],
               [1,1,1,1,1,1,1,1,1]]

var stage=document.getElementById("stage");
var maze=document.getElementById("maze");

genBoxes(inputData);

// 配列を受け取って迷路を作る
function genBoxes(arr) {
    for (x = 0; x < arr.length; x++)
    {
        var outStr = '';
        for (z = 0; z < arr[0].length; z++)
        {
            outStr += arr[x][z] + ',';
            if (arr[x][z] == '1')
            {
                var p = (x + ' ' + 0 + ' ' + z);
                var r = '0 0 0';
                var c = '#323232';
                var boxNode = genBoxNode(p, r, c);
                boxNode.setAttribute('boxid', 'box' + x + '_' + z);
                maze.appendChild(boxNode);
            }
        }
    }
}


// 迷路用のボックスを作る
function genBoxNode(p, r, c) {
    var boxNode = document.createElement('a-box');
    boxNode.setAttribute('position', p);
    boxNode.setAttribute('rotation', r);
    boxNode.setAttribute('width', 1);
    boxNode.setAttribute('height', 2);
    boxNode.setAttribute('depth', 1);
    boxNode.setAttribute('color', c);
    boxNode.setAttribute('static-body', "");

    return boxNode;
}



/*

document.getElementById("back").addEventListener("mousedown", (e)=>
{
document.dispatchEvent( new KeyboardEvent( "keydown",{key: 40 })) ;
},false);
*/


var speed;
var rig = document.getElementById('rig');
var position = rig.getAttribute('position');
var rotation = rig.getAttribute('rotation');



function movePlayer()
{
 position = rig.getAttribute('position');
    rotation = rig.getAttribute('rotation');

       position.x += -Math.cos((rotation.y - 90) * Math.PI / 180) * speed;
       position.z += Math.sin((rotation.y - 90) * Math.PI / 180) * speed;
       rig.setAttribute('position', position);
}


function render()
{
    requestAnimationFrame(render);
    movePlayer();
}



document.getElementById("back").addEventListener("mousedown", (e)=>
{
speed = -0.01;
render();
console.log(rig.getAttribute('position'));
},false);



document.getElementById("back").addEventListener("mouseup", (e)=>
{
  speed = 0;
  //cancelAnimationFrame(render);
  console.log("ok")
  console.log(rig.getAttribute('position'));
},false);



/*
function movePlayer()
{


    var camera = document.getElementById('camera');

        var position = camera.getAttribute('position');
        var rotation = camera.getAttribute('rotation');

       // position.x += -Math.cos((rotation.y - 90) * Math.PI / 180) * speed;
       // position.z += Math.sin((rotation.y - 90) * Math.PI / 180) * speed;
        camera.setAttribute('position', position);

}


var t = 0;

function render()
{
    t += 0.01;
    requestAnimationFrame(render);
    movePlayer();
}

render();
*/

</script>

</a-scene>


</body></html>